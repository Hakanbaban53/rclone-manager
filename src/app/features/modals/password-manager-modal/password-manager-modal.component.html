<div class="modal">
  <div class="modal-header">
    <!-- Desktop tabs -->
    <div class="tabs desktop-tabs" *ngIf="!bottomTabs">
      <button
        *ngFor="let tab of tabs; let i = index; trackBy: trackByTab"
        type="button"
        class="tab"
        [class.selected]="i === selectedTabIndex"
        [disabled]="isTabDisabled(tab.key)"
        (click)="selectTab(i)"
        [attr.aria-selected]="i === selectedTabIndex"
        role="tab"
      >
        <mat-icon class="icon" [svgIcon]="tab.icon"></mat-icon>
        <span class="tab-label">{{ tab.label }}</span>
      </button>
    </div>

    <!-- Mobile title when tabs are at bottom -->
    <h2 class="modal-title" *ngIf="bottomTabs">
      <mat-icon class="icon" svgIcon="key"></mat-icon>
      <span>Password Manager</span>
    </h2>

    <button
      type="button"
      class="close-button"
      (click)="close()"
      aria-label="Close password manager dialog"
    >
      <mat-icon svgIcon="close"></mat-icon>
    </button>
  </div>

  <main class="modal-content">
    <!-- Overview Tab -->
    <div class="tab-content" *ngIf="selectedTab === 'overview'">
      <!-- Security Status Section -->
      <section class="section">
        <div class="section-header">
          <h3>Security Status</h3>
          <p class="section-description">Current status of your rclone configuration security</p>
        </div>

        <div class="status-cards">
          <div
            class="status-card"
            [class.success]="hasStoredPassword"
            [class.warning]="!hasStoredPassword"
          >
            <div class="status-icon">
              <mat-icon [svgIcon]="hasStoredPassword ? 'check-circle' : 'warning'"></mat-icon>
            </div>
            <div class="status-content">
              <h4>Stored Password</h4>
              <p>{{ hasStoredPassword ? 'Password is securely stored' : 'No password stored' }}</p>
            </div>
          </div>

          <div class="status-card" [class.success]="hasEnvPassword" [class.info]="!hasEnvPassword">
            <div class="status-icon">
              <mat-icon [svgIcon]="hasEnvPassword ? 'check-circle' : 'circle-info'"></mat-icon>
            </div>
            <div class="status-content">
              <h4>Environment Variable</h4>
              <p>
                {{ hasEnvPassword ? 'RCLONE_CONFIG_PASS is set' : 'Environment variable not set' }}
              </p>
            </div>
          </div>

          <div
            class="status-card"
            [class.success]="isConfigEncrypted"
            [class.info]="!isConfigEncrypted"
          >
            <div class="status-icon">
              <mat-icon [svgIcon]="isConfigEncrypted ? 'lock' : 'lock-open'"></mat-icon>
            </div>
            <div class="status-content">
              <h4>Configuration</h4>
              <p>
                {{
                  isConfigEncrypted
                    ? 'Configuration is encrypted'
                    : 'Configuration is not encrypted'
                }}
              </p>
            </div>
          </div>

          <div
            class="status-card"
            *ngIf="lockoutStatus"
            [class.error]="lockoutStatus.is_locked"
            [class.warning]="lockoutStatus.failed_attempts > 0"
          >
            <div class="status-icon">
              <mat-icon
                [svgIcon]="
                  lockoutStatus.is_locked
                    ? 'lock'
                    : lockoutStatus.failed_attempts > 0
                      ? 'warning'
                      : 'security'
                "
              ></mat-icon>
            </div>
            <div class="status-content">
              <h4>Security Lock</h4>
              <p *ngIf="!lockoutStatus.is_locked">
                {{ lockoutStatus.failed_attempts }}/{{ lockoutStatus.max_attempts }} failed attempts
              </p>
              <p *ngIf="lockoutStatus.is_locked" class="error-text">
                Locked ({{ formatTime(lockoutStatus.remaining_lockout_time || 0) }} remaining)
              </p>
            </div>
          </div>
        </div>
      </section>

      <!-- Password Management Section -->
      <section class="section">
        <div class="section-header">
          <h3>Password Management</h3>
          <p class="section-description">Manage your rclone configuration password</p>
        </div>

        <div class="password-form">
          <mat-form-field appearance="outline" class="password-field">
            <mat-label>Configuration Password</mat-label>
            <input
              matInput
              type="password"
              [(ngModel)]="password"
              placeholder="Enter your rclone config password"
              [disabled]="!!lockoutStatus?.is_locked"
            />
            <mat-icon matSuffix svgIcon="key"></mat-icon>
          </mat-form-field>

          <div class="password-actions">
            <button
              mat-raised-button
              color="primary"
              (click)="storePassword()"
              [disabled]="!password || isLoading || !!lockoutStatus?.is_locked"
            >
              <mat-spinner diameter="20" *ngIf="isLoading"></mat-spinner>
              <mat-icon *ngIf="!isLoading" svgIcon="save"></mat-icon>
              Store Password
            </button>

            <button
              mat-stroked-button
              (click)="validatePassword()"
              [disabled]="!password || isValidating || !!lockoutStatus?.is_locked"
            >
              <mat-spinner diameter="20" *ngIf="isValidating"></mat-spinner>
              <mat-icon *ngIf="!isValidating" svgIcon="circle-check"></mat-icon>
              Validate
            </button>

            <button
              mat-stroked-button
              color="warn"
              (click)="removePassword()"
              [disabled]="!hasStoredPassword || isLoading"
              *ngIf="hasStoredPassword"
            >
              <mat-icon svgIcon="trash"></mat-icon>
              Remove
            </button>
          </div>
        </div>
      </section>
    </div>

    <!-- Security Tab (Encryption) -->
    <div class="tab-content" *ngIf="selectedTab === 'security'">
      <section class="section">
        <div class="section-header">
          <h3>Configuration Encryption</h3>
          <p class="section-description">
            Encrypt your rclone configuration file for enhanced security
          </p>
        </div>

        <div class="encryption-status">
          <div
            class="status-indicator"
            [class.encrypted]="isConfigEncrypted"
            [class.unencrypted]="!isConfigEncrypted"
          >
            <mat-icon [svgIcon]="isConfigEncrypted ? 'lock' : 'lock-open'"></mat-icon>
            <span>{{
              isConfigEncrypted ? 'Configuration is encrypted' : 'Configuration is not encrypted'
            }}</span>
          </div>
        </div>

        <!-- Encrypt Configuration -->
        <div class="encryption-form" *ngIf="!isConfigEncrypted">
          <mat-form-field appearance="outline" class="password-field">
            <mat-label>Password for Encryption</mat-label>
            <input
              matInput
              type="password"
              [(ngModel)]="password"
              placeholder="Enter password to encrypt configuration"
            />
            <mat-icon matSuffix svgIcon="lock"></mat-icon>
          </mat-form-field>

          <button
            mat-raised-button
            color="primary"
            (click)="encryptConfig()"
            [disabled]="!password || isEncrypting"
          >
            <mat-spinner diameter="20" *ngIf="isEncrypting"></mat-spinner>
            <mat-icon *ngIf="!isEncrypting" svgIcon="lock"></mat-icon>
            Encrypt Configuration
          </button>
        </div>

        <!-- Decrypt Configuration -->
        <div class="encryption-form" *ngIf="isConfigEncrypted">
          <mat-form-field appearance="outline" class="password-field">
            <mat-label>Password for Decryption</mat-label>
            <input
              matInput
              type="password"
              [(ngModel)]="password"
              placeholder="Enter password to decrypt configuration"
            />
            <mat-icon matSuffix svgIcon="lock-open"></mat-icon>
          </mat-form-field>

          <button
            mat-stroked-button
            color="warn"
            (click)="unencryptConfig()"
            [disabled]="!password || isUnencrypting"
          >
            <mat-spinner diameter="20" *ngIf="isUnencrypting"></mat-spinner>
            <mat-icon *ngIf="!isUnencrypting" svgIcon="lock-open"></mat-icon>
            Remove Encryption
          </button>
        </div>

        <!-- Change Password Section -->
        <div class="subsection" *ngIf="isConfigEncrypted">
          <div class="section-header">
            <h4>Change Password</h4>
            <p class="section-description">Update the encryption password for your configuration</p>
          </div>

          <div class="password-change-form">
            <mat-form-field appearance="outline">
              <mat-label>Current Password</mat-label>
              <input
                matInput
                type="password"
                [(ngModel)]="currentPassword"
                placeholder="Enter current password"
              />
              <mat-icon matSuffix svgIcon="key"></mat-icon>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>New Password</mat-label>
              <input
                matInput
                type="password"
                [(ngModel)]="newPassword"
                placeholder="Enter new password"
              />
              <mat-icon matSuffix svgIcon="key"></mat-icon>
            </mat-form-field>

            <button
              mat-raised-button
              color="accent"
              (click)="changePassword()"
              [disabled]="!currentPassword || !newPassword || isChangingPassword"
            >
              <mat-spinner diameter="20" *ngIf="isChangingPassword"></mat-spinner>
              <mat-icon *ngIf="!isChangingPassword" svgIcon="refresh"></mat-icon>
              Change Password
            </button>
          </div>
        </div>
      </section>
    </div>

    <!-- Advanced Tab -->
    <div class="tab-content" *ngIf="selectedTab === 'advanced'">
      <section class="section">
        <div class="section-header">
          <h3>Environment Variables</h3>
          <p class="section-description">
            Manage the RCLONE_CONFIG_PASS environment variable for automatic password handling
          </p>
        </div>

        <div class="env-actions">
          <button
            mat-raised-button
            color="primary"
            (click)="setEnvPassword()"
            [disabled]="!hasStoredPassword || isLoading"
          >
            <mat-icon svgIcon="upload"></mat-icon>
            Set Environment Variable
          </button>

          <button
            mat-stroked-button
            color="warn"
            (click)="clearEnvPassword()"
            [disabled]="!hasEnvPassword || isLoading"
          >
            <mat-icon svgIcon="trash"></mat-icon>
            Clear Environment Variable
          </button>
        </div>
      </section>

      <section class="section">
        <div class="section-header">
          <h3>Security Reset</h3>
          <p class="section-description">Reset security status and clear lockout timers</p>
        </div>

        <button mat-stroked-button color="warn" (click)="resetValidator()" [disabled]="isLoading">
          <mat-icon svgIcon="refresh"></mat-icon>
          Reset Security Status
        </button>
      </section>

      <section class="section danger-section">
        <div class="section-header">
          <h3>Danger Zone</h3>
          <p class="section-description">
            These actions permanently remove all stored credentials and security data
          </p>
        </div>

        <button
          mat-stroked-button
          color="warn"
          (click)="clearAllCredentials()"
          [disabled]="isLoading"
        >
          <mat-icon svgIcon="delete-forever"></mat-icon>
          Clear All Credentials
        </button>
      </section>
    </div>
  </main>

  <!-- Mobile tabs at bottom -->
  <div class="bottom-tabs" *ngIf="bottomTabs">
    <button
      *ngFor="let tab of tabs; let i = index; trackBy: trackByTab"
      type="button"
      class="tab"
      [class.selected]="i === selectedTabIndex"
      [disabled]="isTabDisabled(tab.key)"
      (click)="selectTab(i)"
      [attr.aria-selected]="i === selectedTabIndex"
      role="tab"
    >
      <mat-icon class="icon" [svgIcon]="tab.icon"></mat-icon>
      <span class="label">{{ tab.label }}</span>
    </button>
  </div>
</div>
