<div class="modal">
  <div class="modal-header" data-tauri-drag-region>
    <button>
      <mat-icon></mat-icon>
    </button>

    @if (bottomTabs) {
      <h2 class="modal-title">
        <mat-icon class="icon" svgIcon="key"></mat-icon>
        <span>Password Manager</span>
      </h2>
    } @else {
      <div class="tabs desktop-tabs" data-tauri-drag-region role="tablist">
        @for (tab of tabs; track tab; let i = $index) {
          <button
            (click)="selectTab(i)"
            [class.selected]="selectedTabIndex === i"
            [attr.aria-selected]="selectedTabIndex === i"
            [attr.tabindex]="selectedTabIndex === i ? 0 : -1"
            role="tab"
          >
            <mat-icon [svgIcon]="tab.icon"></mat-icon>
            <span class="tab-label">{{ tab.label }}</span>
          </button>
        }
      </div>
    }

    <button matIconButton (click)="close()" aria-label="Close password manager dialog">
      <mat-icon svgIcon="circle-xmark"></mat-icon>
    </button>
  </div>

  <main class="modal-content">
    <!-- Loading State -->
    @if (isLoadingData) {
      <div class="card loading-card">
        <div class="card-content">
          <div class="loading-content">
            <mat-spinner diameter="48"></mat-spinner>
            <h3>Loading Configuration...</h3>
            <p>Checking encryption status</p>
          </div>
        </div>
      </div>
    } @else {
      <!-- Overview Tab -->
      @if (selectedTab === 'overview') {
        <div class="tab-content">
          <!-- Configuration Not Encrypted - Get Started -->
          @if (!isConfigEncrypted) {
            <div class="card get-started-card">
              <div class="card-header">
                <div class="card-title">
                  <mat-icon svgIcon="lock-open"></mat-icon>
                  <h3>Configuration Not Encrypted</h3>
                </div>
                <p class="card-description">
                  Your rclone configuration is currently unencrypted. Encrypt it to protect your
                  remote access credentials.
                </p>
              </div>

              <div class="card-content">
                <div class="get-started-content">
                  <div class="benefits-list">
                    <div class="benefit-item">
                      <mat-icon svgIcon="shield"></mat-icon>
                      <span>Protect your remote credentials from unauthorized access</span>
                    </div>
                    <div class="benefit-item">
                      <mat-icon svgIcon="lock"></mat-icon>
                      <span>Secure password-based encryption for configuration files</span>
                    </div>
                  </div>
                </div>
              </div>
              <div class="card-actions">
                <button
                  matButton="filled"
                  (click)="switchToSecurityTab()"
                  class="action-button-large primary"
                >
                  <mat-icon svgIcon="lock"></mat-icon>
                  Encrypt Configuration
                </button>

                <button
                  matButton="outlined"
                  (click)="learnMoreAboutEncryption()"
                  class="action-button-large"
                >
                  <mat-icon svgIcon="open-link"></mat-icon>
                  Learn More
                </button>
              </div>
            </div>
          } @else {
            <!-- Configuration Is Encrypted - Security Status -->
            <div class="card">
              <div class="card-header">
                <div class="card-title">
                  <mat-icon svgIcon="shield"></mat-icon>
                  <h3>Security Status</h3>
                </div>
                <p class="card-description">
                  Current status of your encrypted rclone configuration
                </p>
              </div>

              <div class="card-content">
                <div class="status-grid">
                  <!-- Configuration Status -->
                  <div class="status-item">
                    <div class="status-indicator">
                      <mat-icon svgIcon="lock"></mat-icon>
                    </div>
                    <div class="status-details">
                      <h4>Configuration</h4>
                      <p>Configuration is encrypted and secure</p>
                    </div>
                  </div>

                  <!-- Stored Password Status -->
                  <div
                    class="status-item"
                    [class.success]="hasStoredPassword"
                    [class.warning]="!hasStoredPassword"
                  >
                    <div class="status-indicator">
                      <mat-icon
                        [svgIcon]="hasStoredPassword ? 'circle-check' : 'warning'"
                      ></mat-icon>
                    </div>
                    <div class="status-details">
                      <h4>Stored Password</h4>
                      <p>
                        {{
                          hasStoredPassword ? 'Password is securely stored' : 'No password stored'
                        }}
                      </p>
                    </div>
                  </div>

                  <!-- Environment Variable Status -->
                  @if (hasEnvPassword) {
                    <div class="status-item success">
                      <div class="status-indicator">
                        <mat-icon svgIcon="circle-check"></mat-icon>
                      </div>
                      <div class="status-details">
                        <h4>Environment Variable</h4>
                        <p>RCLONE_CONFIG_PASS is set</p>
                      </div>
                    </div>
                  }
                </div>
              </div>
            </div>

            <!-- Password & Quick Actions Card -->
            @if (isConfigEncrypted) {
              <div class="card">
                <div class="card-header">
                  <div class="card-title">
                    <mat-icon svgIcon="key"></mat-icon>
                    <h3>Password Management</h3>
                  </div>
                  <p class="card-description">
                    Enter your rclone configuration password and manage quick actions
                  </p>
                </div>

                <div class="card-content">
                  <div class="password-actions-grid">
                    <form [formGroup]="overviewForm">
                      <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Configuration Password</mat-label>
                        <input
                          matInput
                          type="password"
                          formControlName="password"
                          placeholder="Enter your rclone config password"
                          autocomplete="current-password"
                        />
                        <mat-icon matSuffix svgIcon="key"></mat-icon>
                        @if (overviewForm.get('password')?.hasError('required')) {
                          <mat-error> Password is required </mat-error>
                        }
                        @if (overviewForm.get('password')?.hasError('minLength')) {
                          <mat-error>
                            {{ overviewForm.get('password')?.errors?.['minLength']?.message }}
                          </mat-error>
                        }
                        @if (overviewForm.get('password')?.hasError('invalidChars')) {
                          <mat-error>
                            {{ overviewForm.get('password')?.errors?.['invalidChars']?.message }}
                          </mat-error>
                        }
                        @if (overviewForm.get('password')?.hasError('apiError')) {
                          <mat-error>
                            {{ overviewForm.get('password')?.errors?.['apiError']?.message }}
                          </mat-error>
                        }
                      </mat-form-field>
                    </form>
                  </div>
                </div>
                <div class="card-actions">
                  <button
                    matButton="filled"
                    [disabled]="!canValidatePassword || loading.isValidating"
                    (click)="validatePassword()"
                  >
                    <mat-icon svgIcon="circle-check"></mat-icon>
                    @if (loading.isValidating) {
                      Validating...
                    } @else {
                      Validate Password
                    }
                  </button>

                  @if (!hasStoredPassword) {
                    <button
                      matButton="outlined"
                      [disabled]="!canStorePassword || loading.isStoringPassword"
                      (click)="storePassword()"
                    >
                      <mat-icon svgIcon="key"></mat-icon>
                      @if (loading.isStoringPassword) {
                        Saving...
                      } @else {
                        Store Password
                      }
                    </button>
                  }

                  @if (hasStoredPassword) {
                    <button
                      matButton="outlined"
                      class="action-button"
                      [disabled]="loading.isRemovingPassword"
                      (click)="removePassword()"
                    >
                      <mat-icon svgIcon="trash"></mat-icon>
                      @if (loading.isRemovingPassword) {
                        Removing...
                      } @else {
                        Remove Stored Password
                      }
                    </button>
                  }
                </div>
              </div>
            }
          }
        </div>
      }

      <!-- Security Tab -->
      @if (selectedTab === 'security') {
        <div class="tab-content">
          <!-- Configuration Encryption Card -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">
                <mat-icon [svgIcon]="isConfigEncrypted ? 'lock' : 'lock-open'"></mat-icon>
                <h3>Configuration Encryption</h3>
              </div>
              <p class="card-description">
                Encrypt your rclone configuration file for enhanced security
              </p>
            </div>

            <div class="card-content">
              <!-- Current Status -->
              <div
                class="encryption-status"
                [class.encrypted]="isConfigEncrypted"
                [class.unencrypted]="!isConfigEncrypted"
              >
                <mat-icon [svgIcon]="isConfigEncrypted ? 'lock' : 'lock-open'"></mat-icon>
                <span>{{
                  isConfigEncrypted
                    ? 'Configuration is encrypted'
                    : 'Configuration is not encrypted'
                }}</span>
              </div>

              <!-- Encrypt/Decrypt Form -->
              <div class="encryption-form">
                <form [formGroup]="encryptionForm">
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>{{
                      isConfigEncrypted ? 'Password for Decryption' : 'Password for Encryption'
                    }}</mat-label>
                    <input
                      matInput
                      type="password"
                      formControlName="password"
                      [placeholder]="
                        isConfigEncrypted
                          ? 'Enter password to decrypt configuration'
                          : 'Enter password to encrypt configuration'
                      "
                      autocomplete="current-password"
                    />
                    <mat-icon
                      matSuffix
                      [svgIcon]="isConfigEncrypted ? 'lock-open' : 'lock'"
                    ></mat-icon>
                    @if (encryptionForm.get('password')?.hasError('required')) {
                      <mat-error> Password is required </mat-error>
                    }
                    @if (encryptionForm.get('password')?.hasError('minLength')) {
                      <mat-error>
                        {{ encryptionForm.get('password')?.errors?.['minLength']?.message }}
                      </mat-error>
                    }
                    @if (encryptionForm.get('password')?.hasError('invalidChars')) {
                      <mat-error>
                        {{ encryptionForm.get('password')?.errors?.['invalidChars']?.message }}
                      </mat-error>
                    }
                  </mat-form-field>

                  @if (!isConfigEncrypted) {
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>Confirm Password</mat-label>
                      <input
                        matInput
                        type="password"
                        formControlName="confirmPassword"
                        placeholder="Confirm your password"
                        autocomplete="new-password"
                      />
                      <mat-icon matSuffix svgIcon="lock"></mat-icon>
                      @if (encryptionForm.get('confirmPassword')?.hasError('required')) {
                        <mat-error> Please confirm your password </mat-error>
                      }
                      @if (encryptionForm.hasError('passwordMismatch')) {
                        <mat-error>
                          {{ encryptionForm.errors?.['passwordMismatch']?.message }}
                        </mat-error>
                      }
                    </mat-form-field>
                  }
                </form>
              </div>
            </div>

            <div class="card-actions">
              @if (!isConfigEncrypted) {
                <button
                  matButton="filled"
                  (click)="encryptConfig()"
                  [disabled]="!canEncrypt || loading.isEncrypting"
                  class="action-button-large"
                >
                  <mat-icon svgIcon="lock"></mat-icon>
                  @if (loading.isEncrypting) {
                    Encrypting...
                  } @else {
                    Encrypt Configuration
                  }
                </button>
              } @else {
                <button
                  matButton="outlined"
                  (click)="unencryptConfig()"
                  [disabled]="!canUnencrypt || loading.isUnencrypting"
                  class="action-button-large warn"
                >
                  <mat-icon svgIcon="lock-open"></mat-icon>
                  @if (loading.isUnencrypting) {
                    Decrypting...
                  } @else {
                    Decrypt Configuration
                  }
                </button>
              }
            </div>
          </div>

          <!-- Change Password Card -->
          @if (isConfigEncrypted) {
            <div class="card">
              <div class="card-header">
                <div class="card-title">
                  <mat-icon svgIcon="key"></mat-icon>
                  <h3>Change Password</h3>
                </div>
                <p class="card-description">
                  Update the encryption password for your configuration. Both passwords must meet
                  security requirements. This will be unencrypted and re-encrypted with the new
                  password.
                </p>
              </div>

              <div class="card-content">
                <form [formGroup]="changePasswordForm" class="password-change-form">
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Current Password</mat-label>
                    <input
                      matInput
                      type="password"
                      formControlName="currentPassword"
                      placeholder="Enter current password"
                      autocomplete="current-password"
                    />
                    <mat-icon matSuffix svgIcon="key"></mat-icon>
                    @if (changePasswordForm.get('currentPassword')?.hasError('required')) {
                      <mat-error> Current password is required </mat-error>
                    }
                    @if (changePasswordForm.get('currentPassword')?.hasError('minLength')) {
                      <mat-error>
                        {{
                          changePasswordForm.get('currentPassword')?.errors?.['minLength']?.message
                        }}
                      </mat-error>
                    }
                    @if (changePasswordForm.get('currentPassword')?.hasError('invalidChars')) {
                      <mat-error>
                        {{
                          changePasswordForm.get('currentPassword')?.errors?.['invalidChars']
                            ?.message
                        }}
                      </mat-error>
                    }
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>New Password</mat-label>
                    <input
                      matInput
                      type="password"
                      formControlName="newPassword"
                      placeholder="Enter new password"
                      autocomplete="new-password"
                    />
                    <mat-icon matSuffix svgIcon="key"></mat-icon>
                    @if (changePasswordForm.get('newPassword')?.hasError('required')) {
                      <mat-error> New password is required </mat-error>
                    }
                    @if (changePasswordForm.get('newPassword')?.hasError('minLength')) {
                      <mat-error>
                        {{ changePasswordForm.get('newPassword')?.errors?.['minLength']?.message }}
                      </mat-error>
                    }
                    @if (changePasswordForm.get('newPassword')?.hasError('invalidChars')) {
                      <mat-error>
                        {{
                          changePasswordForm.get('newPassword')?.errors?.['invalidChars']?.message
                        }}
                      </mat-error>
                    }
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Confirm New Password</mat-label>
                    <input
                      matInput
                      type="password"
                      formControlName="confirmNewPassword"
                      placeholder="Confirm your new password"
                      autocomplete="new-password"
                    />
                    <mat-icon matSuffix svgIcon="key"></mat-icon>
                    @if (changePasswordForm.get('confirmNewPassword')?.hasError('required')) {
                      <mat-error> Please confirm your new password </mat-error>
                    }
                    @if (changePasswordForm.hasError('passwordMismatch')) {
                      <mat-error>
                        {{ changePasswordForm.errors?.['passwordMismatch']?.message }}
                      </mat-error>
                    }
                  </mat-form-field>
                </form>
              </div>

              <div class="card-actions">
                <button
                  matButton="filled"
                  (click)="changePassword()"
                  [disabled]="!canChangePassword || loading.isChangingPassword"
                  class="action-button-large primary"
                >
                  <mat-icon svgIcon="key"></mat-icon>
                  @if (loading.isChangingPassword) {
                    Changing Password...
                  } @else {
                    Change Password
                  }
                </button>
              </div>
            </div>
          }
        </div>
      }

      <!-- Advanced Tab -->
      @if (selectedTab === 'advanced') {
        <div class="tab-content">
          @if (!isConfigEncrypted) {
            <div class="card">
              <div class="card-header">
                <div class="card-title">
                  <mat-icon svgIcon="lock-open"></mat-icon>
                  <h3>Advanced Settings</h3>
                </div>
                <p class="card-description">
                  Advanced settings are available when your configuration is encrypted
                </p>
              </div>
              <div class="card-actions">
                <button
                  matButton="filled"
                  (click)="switchToSecurityTab()"
                  class="action-button-large primary"
                >
                  <mat-icon svgIcon="lock"></mat-icon>
                  Go to Security Settings
                </button>
              </div>
            </div>
          } @else {
            <!-- Environment Variables Card -->
            <div class="card">
              <div class="card-header">
                <div class="card-title">
                  <mat-icon svgIcon="terminal"></mat-icon>
                  <h3>Environment Variables</h3>
                </div>
                <p class="card-description">
                  Manage password environment variables for the current session
                </p>
              </div>

              <div class="card-content">
                <div class="status-grid">
                  <!-- RCLONE_CONFIG_PASS Status -->
                  <div class="status-item">
                    <div class="status-indicator">
                      <mat-icon
                        [svgIcon]="hasEnvPassword ? 'circle-check' : 'circle-info'"
                      ></mat-icon>
                    </div>
                    <div class="status-details">
                      <h4>RCLONE_CONFIG_PASS:</h4>
                      <p>{{ hasEnvPassword ? 'Set' : 'Not set' }}</p>
                    </div>
                  </div>
                </div>
              </div>
              <div class="card-actions">
                <button
                  matButton="outlined"
                  (click)="setEnvPassword()"
                  [disabled]="!hasStoredPassword || loading.isSettingEnv"
                >
                  <mat-icon svgIcon="terminal"></mat-icon>
                  @if (loading.isSettingEnv) {
                    Saving...
                  } @else {
                    Set Environment Variable
                  }
                </button>

                <button
                  matButton="outlined"
                  class="warn"
                  (click)="clearEnvPassword()"
                  [disabled]="!hasEnvPassword || loading.isClearingEnv"
                >
                  <mat-icon svgIcon="close"></mat-icon>
                  @if (loading.isClearingEnv) {
                    Clearing...
                  } @else {
                    Clear Environment Variable
                  }
                </button>
              </div>
            </div>
          }
        </div>
      }
    }
  </main>
  <!-- Bottom Tabs (Mobile) -->
  @if (bottomTabs) {
    <div class="tabs bottom-tabs" role="tablist">
      @for (tab of tabs; track tab; let i = $index) {
        <button
          (click)="selectTab(i)"
          [class.selected]="selectedTabIndex === i"
          [attr.aria-selected]="selectedTabIndex === i"
          [attr.tabindex]="selectedTabIndex === i ? 0 : -1"
          role="tab"
        >
          <mat-icon [svgIcon]="tab.icon"></mat-icon>
          <span class="tab-label">{{ tab.label }}</span>
        </button>
      }
    </div>
  }
</div>
