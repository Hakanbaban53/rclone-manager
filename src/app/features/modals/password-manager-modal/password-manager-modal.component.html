<div class="modal">
  <div class="modal-header" data-tauri-drag-region>
    <button disabled>
      <mat-icon></mat-icon>
    </button>

    @if (bottomTabs) {
      <h2 class="modal-title">
        <mat-icon class="icon" svgIcon="key"></mat-icon>
        <span>Password Manager</span>
      </h2>
    } @else {
      <div class="tabs desktop-tabs" data-tauri-drag-region role="tablist">
        @for (tab of tabs; track tab; let i = $index) {
          <button
            (click)="selectTab(i)"
            [class.selected]="selectedTabIndex === i"
            [attr.aria-selected]="selectedTabIndex === i"
            [attr.tabindex]="selectedTabIndex === i ? 0 : -1"
            role="tab"
          >
            <mat-icon [svgIcon]="tab.icon"></mat-icon>
            <span class="tab-label">{{ tab.label }}</span>
          </button>
        }
      </div>
    }

    <button mat-icon-button (click)="close()" aria-label="Close password manager dialog">
      <mat-icon svgIcon="circle-xmark"></mat-icon>
    </button>
  </div>

  <main class="modal-content">
    <!-- Overview Tab -->
    @if (selectedTab === 'overview') {
      <div class="tab-content">
        <!-- Configuration Not Encrypted - Get Started -->
        @if (!isConfigEncrypted) {
          <div class="card get-started-card">
            <div class="card-header">
              <div class="card-title">
                <mat-icon svgIcon="lock-open"></mat-icon>
                <h3>Configuration Not Encrypted</h3>
              </div>
              <p class="card-description">
                Your rclone configuration is currently unencrypted. Encrypt it to protect your
                remote access credentials.
              </p>
            </div>

            <div class="card-content">
              <div class="get-started-content">
                <div class="benefits-list">
                  <div class="benefit-item">
                    <mat-icon svgIcon="shield"></mat-icon>
                    <span>Protect your remote credentials from unauthorized access</span>
                  </div>
                  <div class="benefit-item">
                    <mat-icon svgIcon="lock"></mat-icon>
                    <span>Secure password-based encryption for configuration files</span>
                  </div>
                </div>
              </div>
            </div>
            <div class="card-actions">
              <button
                mat-raised-button
                color="primary"
                (click)="switchToSecurityTab()"
                class="action-button-large"
              >
                <mat-icon svgIcon="lock"></mat-icon>
                Encrypt Configuration
              </button>

              <button
                mat-stroked-button
                (click)="learnMoreAboutEncryption()"
                class="action-button-large"
              >
                <mat-icon svgIcon="open-link"></mat-icon>
                Learn More
              </button>
            </div>
          </div>
        } @else {
          <!-- Configuration Is Encrypted - Security Status -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">
                <mat-icon svgIcon="shield"></mat-icon>
                <h3>Security Status</h3>
              </div>
              <p class="card-description">Current status of your encrypted rclone configuration</p>
            </div>

            <div class="card-content">
              <div class="status-grid">
                <!-- Configuration Status -->
                <div class="status-item">
                  <div class="status-indicator">
                    <mat-icon svgIcon="lock"></mat-icon>
                  </div>
                  <div class="status-details">
                    <h4>Configuration</h4>
                    <p>Configuration is encrypted and secure</p>
                  </div>
                </div>

                <!-- Stored Password Status -->
                <div
                  class="status-item"
                  [class.success]="hasStoredPassword"
                  [class.warning]="!hasStoredPassword"
                >
                  <div class="status-indicator">
                    <mat-icon [svgIcon]="hasStoredPassword ? 'circle-check' : 'warning'"></mat-icon>
                  </div>
                  <div class="status-details">
                    <h4>Stored Password</h4>
                    <p>
                      {{ hasStoredPassword ? 'Password is securely stored' : 'No password stored' }}
                    </p>
                  </div>
                </div>

                <!-- Environment Variable Status removed (using runtime RC unlock) -->

                <!-- Security Lock Status -->
                @if (
                  lockoutStatus && (lockoutStatus.failed_attempts > 0 || lockoutStatus.is_locked)
                ) {
                  <div
                    class="status-item"
                    [class.error]="lockoutStatus.is_locked"
                    [class.warning]="lockoutStatus.failed_attempts > 0 && !lockoutStatus.is_locked"
                  >
                    <div class="status-indicator">
                      <mat-icon
                        [svgIcon]="
                          lockoutStatus.is_locked
                            ? 'block'
                            : lockoutStatus.failed_attempts > 0
                              ? 'warning'
                              : 'shield'
                        "
                      ></mat-icon>
                    </div>
                    <div class="status-details">
                      <h4>Security Lock</h4>
                      @if (!lockoutStatus.is_locked) {
                        <p>
                          {{ lockoutStatus.failed_attempts }}/{{ lockoutStatus.max_attempts }}
                          failed attempts
                        </p>
                      } @else {
                        <p class="error-text">
                          Locked ({{
                            FormatTimePipe.transform(lockoutStatus.remaining_lockout_time || 0)
                          }}
                          remaining)
                        </p>
                      }
                    </div>
                  </div>
                }
              </div>
            </div>
          </div>

          <!-- Password & Quick Actions Card -->
          @if (isConfigEncrypted) {
            <div class="card">
              <div class="card-header">
                <div class="card-title">
                  <mat-icon svgIcon="key"></mat-icon>
                  <h3>Password Management</h3>
                </div>
                <p class="card-description">
                  Enter your rclone configuration password and manage quick actions
                </p>
              </div>

              <div class="card-content">
                <div class="password-actions-grid">
                  <form [formGroup]="overviewForm">
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>Configuration Password</mat-label>
                      <input
                        matInput
                        type="password"
                        formControlName="password"
                        placeholder="Enter your rclone config password"
                        autocomplete="current-password"
                      />
                      <mat-icon matSuffix svgIcon="key"></mat-icon>
                      <mat-error *ngIf="overviewForm.get('password')?.hasError('required')">
                        Password is required
                      </mat-error>
                      <mat-error *ngIf="overviewForm.get('password')?.hasError('minLength')">
                        {{ overviewForm.get('password')?.errors?.['minLength']?.message }}
                      </mat-error>
                      <mat-error *ngIf="overviewForm.get('password')?.hasError('invalidChars')">
                        {{ overviewForm.get('password')?.errors?.['invalidChars']?.message }}
                      </mat-error>
                      <mat-error *ngIf="overviewForm.get('password')?.hasError('apiError')">
                        {{ overviewForm.get('password')?.errors?.['apiError']?.message }}
                      </mat-error>
                    </mat-form-field>
                  </form>
                </div>
              </div>
              <div class="card-actions">
                <button
                  mat-raised-button
                  color="primary"
                  [disabled]="!canValidatePassword || loading.isValidating"
                  (click)="validatePassword2()"
                >
                  <mat-icon svgIcon="circle-check"></mat-icon>
                  @if (loading.isValidating) {
                    Validating...
                  } @else {
                    Validate Password
                  }
                </button>

                @if (!hasStoredPassword) {
                  <button
                    mat-stroked-button
                    [disabled]="!canStorePassword || loading.isStoringPassword"
                    (click)="storePassword()"
                  >
                    <mat-icon svgIcon="save"></mat-icon>
                    @if (loading.isStoringPassword) {
                      Saving...
                    } @else {
                      Store Password
                    }
                  </button>
                }

                @if (hasStoredPassword) {
                  <button
                    mat-stroked-button
                    color="warn"
                    class="action-button"
                    [disabled]="loading.isRemovingPassword"
                    (click)="removePassword()"
                  >
                    <mat-icon svgIcon="trash"></mat-icon>
                    @if (loading.isRemovingPassword) {
                      Removing...
                    } @else {
                      Remove Stored Password
                    }
                  </button>
                }

                @if (lockoutStatus?.is_locked) {
                  <button mat-stroked-button class="action-button" (click)="resetLockout()">
                    <mat-icon svgIcon="refresh"></mat-icon>
                    Reset Lockout
                  </button>
                }
              </div>

              @if (lockoutStatus?.is_locked) {
                <div class="lockout-warning" role="alert" aria-live="polite">
                  <mat-icon svgIcon="block"></mat-icon>
                  <span>
                    Too many failed attempts. Please wait
                    <strong>{{
                      FormatTimePipe.transform(lockoutStatus?.remaining_lockout_time || 0)
                    }}</strong>
                    before trying again.
                  </span>
                </div>
              }
            </div>
          }
        }
      </div>
    }

    <!-- Security Tab -->
    @if (selectedTab === 'security') {
      <div class="tab-content">
        <!-- Configuration Encryption Card -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <mat-icon [svgIcon]="isConfigEncrypted ? 'lock' : 'lock-open'"></mat-icon>
              <h3>Configuration Encryption</h3>
            </div>
            <p class="card-description">
              Encrypt your rclone configuration file for enhanced security
            </p>
          </div>

          <div class="card-content">
            <!-- Current Status -->
            <div
              class="encryption-status"
              [class.encrypted]="isConfigEncrypted"
              [class.unencrypted]="!isConfigEncrypted"
            >
              <mat-icon [svgIcon]="isConfigEncrypted ? 'lock' : 'lock-open'"></mat-icon>
              <span>{{
                isConfigEncrypted ? 'Configuration is encrypted' : 'Configuration is not encrypted'
              }}</span>
            </div>

            <!-- Encrypt/Decrypt Form -->
            <div class="encryption-form">
              <form [formGroup]="encryptionForm">
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>{{
                    isConfigEncrypted ? 'Password for Decryption' : 'Password for Encryption'
                  }}</mat-label>
                  <input
                    matInput
                    type="password"
                    formControlName="password"
                    [placeholder]="
                      isConfigEncrypted
                        ? 'Enter password to decrypt configuration'
                        : 'Enter password to encrypt configuration'
                    "
                    autocomplete="current-password"
                  />
                  <mat-icon
                    matSuffix
                    [svgIcon]="isConfigEncrypted ? 'lock-open' : 'lock'"
                  ></mat-icon>
                  <mat-error *ngIf="encryptionForm.get('password')?.hasError('required')">
                    Password is required
                  </mat-error>
                  <mat-error *ngIf="encryptionForm.get('password')?.hasError('minLength')">
                    {{ encryptionForm.get('password')?.errors?.['minLength']?.message }}
                  </mat-error>
                  <mat-error *ngIf="encryptionForm.get('password')?.hasError('invalidChars')">
                    {{ encryptionForm.get('password')?.errors?.['invalidChars']?.message }}
                  </mat-error>
                </mat-form-field>

                @if (!isConfigEncrypted) {
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Confirm Password</mat-label>
                    <input
                      matInput
                      type="password"
                      formControlName="confirmPassword"
                      placeholder="Confirm your password"
                      autocomplete="new-password"
                    />
                    <mat-icon matSuffix svgIcon="lock"></mat-icon>
                    <mat-error *ngIf="encryptionForm.get('confirmPassword')?.hasError('required')">
                      Please confirm your password
                    </mat-error>
                    <mat-error *ngIf="encryptionForm.hasError('passwordMismatch')">
                      {{ encryptionForm.errors?.['passwordMismatch']?.message }}
                    </mat-error>
                  </mat-form-field>
                }
              </form>
            </div>
          </div>

          <div class="card-actions">
            @if (!isConfigEncrypted) {
              <button
                mat-raised-button
                color="primary"
                (click)="encryptConfig()"
                [disabled]="!canEncrypt || loading.isEncrypting"
                class="action-button-large"
              >
                <mat-icon svgIcon="lock"></mat-icon>
                @if (loading.isEncrypting) {
                  Encrypting...
                } @else {
                  Encrypt Configuration
                }
              </button>
            } @else {
              <button
                mat-stroked-button
                color="warn"
                (click)="unencryptConfig()"
                [disabled]="!canUnencrypt || loading.isUnencrypting"
                class="action-button-large"
              >
                <mat-icon svgIcon="lock-open"></mat-icon>
                @if (loading.isUnencrypting) {
                  Decrypting...
                } @else {
                  Decrypt Configuration
                }
              </button>
            }
          </div>
        </div>

        <!-- Change Password Card -->
        @if (isConfigEncrypted) {
          <div class="card">
            <div class="card-header">
              <div class="card-title">
                <mat-icon svgIcon="key"></mat-icon>
                <h3>Change Password</h3>
              </div>
              <p class="card-description">
                Update the encryption password for your configuration. Both passwords must meet
                security requirements.
              </p>
            </div>

            <div class="card-content">
              <form [formGroup]="changePasswordForm" class="password-change-form">
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Current Password</mat-label>
                  <input
                    matInput
                    type="password"
                    formControlName="currentPassword"
                    placeholder="Enter current password"
                    autocomplete="current-password"
                  />
                  <mat-icon matSuffix svgIcon="key"></mat-icon>
                  <mat-error
                    *ngIf="changePasswordForm.get('currentPassword')?.hasError('required')"
                  >
                    Current password is required
                  </mat-error>
                  <mat-error
                    *ngIf="changePasswordForm.get('currentPassword')?.hasError('minLength')"
                  >
                    {{ changePasswordForm.get('currentPassword')?.errors?.['minLength']?.message }}
                  </mat-error>
                  <mat-error
                    *ngIf="changePasswordForm.get('currentPassword')?.hasError('invalidChars')"
                  >
                    {{
                      changePasswordForm.get('currentPassword')?.errors?.['invalidChars']?.message
                    }}
                  </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>New Password</mat-label>
                  <input
                    matInput
                    type="password"
                    formControlName="newPassword"
                    placeholder="Enter new password"
                    autocomplete="new-password"
                  />
                  <mat-icon matSuffix svgIcon="key"></mat-icon>
                  <mat-error *ngIf="changePasswordForm.get('newPassword')?.hasError('required')">
                    New password is required
                  </mat-error>
                  <mat-error *ngIf="changePasswordForm.get('newPassword')?.hasError('minLength')">
                    {{ changePasswordForm.get('newPassword')?.errors?.['minLength']?.message }}
                  </mat-error>
                  <mat-error
                    *ngIf="changePasswordForm.get('newPassword')?.hasError('invalidChars')"
                  >
                    {{ changePasswordForm.get('newPassword')?.errors?.['invalidChars']?.message }}
                  </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Confirm New Password</mat-label>
                  <input
                    matInput
                    type="password"
                    formControlName="confirmNewPassword"
                    placeholder="Confirm your new password"
                    autocomplete="new-password"
                  />
                  <mat-icon matSuffix svgIcon="key"></mat-icon>
                  <mat-error
                    *ngIf="changePasswordForm.get('confirmNewPassword')?.hasError('required')"
                  >
                    Please confirm your new password
                  </mat-error>
                  <mat-error *ngIf="changePasswordForm.hasError('passwordMismatch')">
                    {{ changePasswordForm.errors?.['passwordMismatch']?.message }}
                  </mat-error>
                </mat-form-field>
              </form>
            </div>

            <div class="card-actions">
              <button
                mat-raised-button
                color="primary"
                (click)="changePassword()"
                [disabled]="!canChangePassword || loading.isChangingPassword"
                class="action-button-large"
              >
                <mat-icon svgIcon="key"></mat-icon>
                @if (loading.isChangingPassword) {
                  Changing Password...
                } @else {
                  Change Password
                }
              </button>
            </div>
          </div>
        }
      </div>
    }

    <!-- Advanced Tab -->
    @if (selectedTab === 'advanced') {
      <div class="tab-content">
        @if (!isConfigEncrypted) {
          <div class="card">
            <div class="card-header">
              <div class="card-title">
                <mat-icon svgIcon="lock-open"></mat-icon>
                <h3>Advanced Settings</h3>
              </div>
              <p class="card-description">
                Advanced settings are available when your configuration is encrypted
              </p>
            </div>
            <div class="card-actions">
              <button
                mat-raised-button
                color="primary"
                (click)="switchToSecurityTab()"
                class="action-button-large"
              >
                <mat-icon svgIcon="lock"></mat-icon>
                Go to Security Settings
              </button>
            </div>
          </div>
        } @else {
          <!-- Environment Variables Card removed (using runtime RC unlock) -->

          <!-- Security Settings Card -->
          @if (lockoutStatus && (lockoutStatus.failed_attempts > 0 || lockoutStatus.is_locked)) {
            <div class="card">
              <div class="card-header">
                <div class="card-title">
                  <mat-icon svgIcon="shield"></mat-icon>
                  <h3>Security Settings</h3>
                </div>
                <p class="card-description">Advanced security and lockout management</p>
              </div>

              <div class="card-content">
                <div class="status-grid">
                  <div class="status-item">
                    <div class="status-indicator">
                      <mat-icon svgIcon="warning"></mat-icon>
                    </div>
                    <div class="status-details">
                      <h4>Failed Attempts:</h4>
                      <p>{{ lockoutStatus.failed_attempts }}/{{ lockoutStatus.max_attempts }}</p>
                    </div>
                  </div>

                  @if (lockoutStatus.is_locked) {
                    <div class="info-row error">
                      <span class="label">Lockout Time Remaining:</span>
                      <span class="value">{{
                        FormatTimePipe.transform(lockoutStatus.remaining_lockout_time || 0)
                      }}</span>
                    </div>
                  }
                </div>
              </div>
              <div class="card-actions">
                <button
                  mat-stroked-button
                  color="accent"
                  (click)="resetLockout()"
                  [disabled]="loading.isResettingLockout"
                  class="action-button-large"
                >
                  <mat-icon svgIcon="refresh"></mat-icon>
                  @if (loading.isResettingLockout) {
                    Resetting...
                  } @else {
                    Reset Password Validator
                  }
                </button>
              </div>
            </div>
          }
        }
      </div>
    }
  </main>
  <!-- Bottom Tabs (Mobile) -->
  @if (bottomTabs) {
    <div class="tabs bottom-tabs" role="tablist">
      @for (tab of tabs; track tab; let i = $index) {
        <button
          (click)="selectTab(i)"
          [class.selected]="selectedTabIndex === i"
          [attr.aria-selected]="selectedTabIndex === i"
          [attr.tabindex]="selectedTabIndex === i ? 0 : -1"
          role="tab"
        >
          <mat-icon [svgIcon]="tab.icon"></mat-icon>
          <span class="tab-label">{{ tab.label }}</span>
        </button>
      }
    </div>
  }
</div>
