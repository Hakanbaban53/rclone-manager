<mat-nav-list class="repair-sheet" [class.repairing]="installing">
  <!-- Header Section with Icon and Content -->
  <div class="sheet-header">
    <!-- Top section with icon and main content -->
    <div class="repair-header-top">
      <div class="repair-icon">
        <mat-icon [svgIcon]="getRepairIcon()"></mat-icon>
      </div>

      <div class="repair-content">
        <h3>{{ data.title || 'Repair Required' }}</h3>
        <p>{{ data.message || 'A problem was detected. You can try repairing it below.' }}</p>
      </div>
    </div>

    @if (getRepairDetails()) {
      <div class="repair-details">
        @for (detail of getRepairDetails(); track $index) {
          <div class="detail-item">
            <mat-icon svgIcon="{{ detail.icon }}"></mat-icon>
            <span
              ><strong>{{ detail.label }}:</strong> {{ detail.value }}</span
            >
          </div>
        }
      </div>
    }

    <!-- Password Section for Password-Required Repairs -->
    @if (requiresPassword()) {
      <div class="password-row">
        <app-password-manager
          [password]="password"
          [storePassword]="storePassword"
          [isSubmitting]="isSubmittingPassword"
          [hasError]="hasPasswordError"
          [errorMessage]="passwordErrorMessage"
          [lockoutStatus]="lockoutStatus"
          [showStoreOption]="!!data.showStoreOption"
          [disabled]="installing"
          (passwordChange)="password = $event"
          (storePasswordChange)="storePassword = $event"
          (unlock)="submitPassword()"
        ></app-password-manager>
      </div>
    }

    <!-- Advanced Options for Rclone Path Repair -->
    @if (isRclonePathRepair()) {
      <div class="advanced-toggle">
        <button
          matButton="filled"
          color="accent"
          (click)="toggleAdvanced()"
          [disabled]="installing"
        >
          <mat-icon
            svgIcon="caret-down"
            [style.transform]="showAdvanced ? 'rotate(180deg)' : 'rotate(0deg)'"
            style="transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)"
          ></mat-icon>
          {{ showAdvanced ? 'Hide' : 'Show' }} Advanced Options
        </button>
      </div>

      @if (showAdvanced) {
        <app-installation-options
          [disabled]="installing"
          (dataChange)="onInstallationOptionsChange($event)"
          (validChange)="onInstallationValidChange($event)"
        >
        </app-installation-options>
      }
    }
  </div>

  <!-- Actions Section -->
  <div class="sheet-actions">
    @if (isMountPluginRepair()) {
      <button
        matButton="outlined"
        [disabled]="isRefreshingStatus || installing"
        class="refresh-button"
        (click)="refreshMountPluginStatus()"
        [attr.aria-label]="
          isRefreshingStatus ? 'Checking status...' : 'Check if mount plugin is now installed'
        "
        [matTooltip]="
          'Check if the mount plugin is now installed. Use this if you installed it manually or the automatic detection failed.'
        "
      >
        @if (isRefreshingStatus) {
          <ng-container>
            <mat-progress-spinner diameter="20" mode="indeterminate"></mat-progress-spinner>
            Checking Status...
          </ng-container>
        } @else {
          <ng-container>
            <mat-icon svgIcon="refresh"></mat-icon>
            Check Status
          </ng-container>
        }
      </button>
    }

    <button
      matButton="filled"
      [disabled]="!canRepair()"
      class="repair-button"
      (click)="repair()"
      [attr.aria-label]="installing ? 'Repairing in progress' : 'Start repair process'"
      [matTooltip]="
        !canRepair() && !installing && !isSubmittingPassword
          ? requiresPassword() && !password
            ? 'Please enter the configuration password first'
            : requiresPassword() && lockoutStatus?.is_locked
              ? 'Account is temporarily locked due to failed attempts'
              : installationData.installLocation === 'custom' &&
                  installationData.customPath.trim().length === 0
                ? 'Please select an installation path first'
                : installationData.installLocation === 'existing' &&
                    installationData.existingBinaryPath.trim().length === 0
                  ? 'Please select a binary file first'
                  : installationData.installLocation === 'existing' &&
                      installationData.binaryTestResult === 'invalid'
                    ? 'The selected file is not a valid rclone binary'
                    : installationData.installLocation === 'existing' &&
                        installationData.binaryTestResult === 'untested'
                      ? 'Please test the selected binary first'
                      : !installationValid
                        ? 'Please fix validation errors'
                        : ''
          : ''
      "
    >
      {{
        installing || isSubmittingPassword
          ? isSubmittingPassword
            ? 'Validating Password...'
            : getRepairProgressText()
          : getRepairButtonText()
      }}
      <mat-icon
        [svgIcon]="
          installing || isSubmittingPassword
            ? installing
              ? 'refresh'
              : 'download'
            : getRepairButtonIcon()
        "
        [class.animate-spin]="installing || isSubmittingPassword"
      ></mat-icon>
    </button>
  </div>
</mat-nav-list>
