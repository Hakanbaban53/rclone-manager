<div class="onboarding-container" data-tauri-drag-region [@onboardingEntrance]>
  <div class="floating-shape"></div>

  <app-loading-overlay
    [isVisible]="isInitializing"
    title="Initializing RClone Manager"
    message="Checking system configuration..."
    icon="refresh"
    overlayType="container"
  >
  </app-loading-overlay>

  <ng-container *ngIf="!isInitializing && initializationComplete">
    <div class="card-container" [@contentFadeIn]>
      <div class="onboarding-header">
        <div class="page-indicators">
          <ng-container *ngFor="let card of cards; let i = index; trackBy: trackByIndex">
            <div
              class="indicator"
              [class.active]="i === currentCardIndex"
              [class.completed]="i < currentCardIndex"
            ></div>
          </ng-container>
        </div>
      </div>

      <div class="content-area">
        <div class="card-content">
          <div class="icon-container">
            <mat-icon [svgIcon]="cards[currentCardIndex].image"></mat-icon>
          </div>

          <div class="text-content">
            <h2 class="card-title">{{ cards[currentCardIndex].title }}</h2>
            <p class="card-description">{{ cards[currentCardIndex].content }}</p>
          </div>

          <ng-container *ngIf="cards[currentCardIndex].title === 'Select RClone Config'">
            <div class="form-section" @slideInOut>
              <app-installation-options
                [mode]="'config'"
                [disabled]="installing"
                [tabOptions]="[
                  { key: 'default', label: 'Default', icon: 'file' },
                  { key: 'custom', label: 'Custom', icon: 'folder' },
                ]"
                (dataChange)="onConfigOptionsChange($event)"
                (validChange)="onConfigValidChange($event)"
              ></app-installation-options>
            </div>
          </ng-container>

          <ng-container *ngIf="cards[currentCardIndex].title === 'Configuration Password Required'">
            <div class="form-section" @slideInOut>
              <app-password-manager
                [password]="configPassword"
                [storePassword]="true"
                [isSubmitting]="isSubmittingPassword"
                [hasError]="!!passwordValidationError"
                [errorMessage]="passwordValidationError || ''"
                [lockoutStatus]="lockoutStatus"
                [showStoreOption]="false"
                (passwordChange)="configPassword = $event"
                (unlock)="submitConfigPassword()"
              ></app-password-manager>
            </div>
          </ng-container>

          <ng-container
            *ngIf="cards[currentCardIndex].title === 'Install RClone' && !rcloneInstalled"
          >
            <div class="form-section" @slideInOut>
              <app-installation-options
                [mode]="'install'"
                [disabled]="installing"
                [tabOptions]="onboardingTabOptions"
                (dataChange)="onInstallationOptionsChange($event)"
                (validChange)="onInstallationValidChange($event)"
              >
              </app-installation-options>
            </div>
          </ng-container>
        </div>
      </div>

      <div class="footer-navigation">
        <div>
          <ng-container *ngIf="currentCardIndex > 0">
            <button mat-button (click)="previousCard()" class="secondary">
              <mat-icon svgIcon="left-arrow"></mat-icon>
              Back
            </button>
          </ng-container>
        </div>

        <div>
          <ng-container *ngIf="shouldShowInstallRcloneButton()">
            <button
              mat-raised-button
              color="primary"
              (click)="installRclone()"
              [disabled]="!canInstallRclone()"
              [matTooltip]="
                !canInstallRclone() ? 'Please complete the installation options above' : ''
              "
            >
              <mat-icon
                [svgIcon]="installing ? 'refresh' : 'download'"
                [class.animate-spin]="installing"
              ></mat-icon>
              {{ getInstallButtonText() }}
            </button>
          </ng-container>

          <ng-container *ngIf="!shouldShowInstallRcloneButton() && shouldShowInstallPluginButton()">
            <button
              mat-raised-button
              color="primary"
              (click)="installMountPlugin()"
              [disabled]="downloadingPlugin"
            >
              <mat-icon
                [svgIcon]="downloadingPlugin ? 'refresh' : 'download'"
                [class.animate-spin]="downloadingPlugin"
              ></mat-icon>
              {{ downloadingPlugin ? 'Installing...' : 'Install Plugin' }}
            </button>
          </ng-container>

          <ng-container
            *ngIf="
              !shouldShowInstallRcloneButton() &&
              !shouldShowInstallPluginButton() &&
              cards[currentCardIndex].title === 'Ready to Go!'
            "
          >
            <button
              mat-raised-button
              color="primary"
              (click)="completeOnboarding()"
              class="finish-button"
            >
              <mat-icon svgIcon="circle-check"></mat-icon>
              Get Started
            </button>
          </ng-container>

          <ng-container
            *ngIf="
              !shouldShowInstallRcloneButton() &&
              !shouldShowInstallPluginButton() &&
              cards[currentCardIndex].title === 'Select RClone Config'
            "
          >
            <button
              mat-raised-button
              color="primary"
              (click)="onConfigNext()"
              [disabled]="!configValid"
              [matTooltip]="
                !configValid ? 'Please select or provide a valid config option first' : ''
              "
            >
              Next
              <mat-icon svgIcon="right-arrow"></mat-icon>
            </button>
          </ng-container>

          <ng-container
            *ngIf="
              !shouldShowInstallRcloneButton() &&
              !shouldShowInstallPluginButton() &&
              cards[currentCardIndex].title === 'Configuration Password Required'
            "
          >
            <button
              mat-raised-button
              color="primary"
              (click)="submitConfigPassword()"
              [disabled]="!configPassword || isSubmittingPassword"
            >
              <mat-progress-spinner
                *ngIf="isSubmittingPassword"
                diameter="18"
                mode="indeterminate"
              ></mat-progress-spinner>
              <span *ngIf="!isSubmittingPassword">Unlock</span>
            </button>
          </ng-container>

          <ng-container
            *ngIf="
              !shouldShowInstallRcloneButton() &&
              !shouldShowInstallPluginButton() &&
              cards[currentCardIndex].title !== 'Ready to Go!' &&
              cards[currentCardIndex].title !== 'Select RClone Config' &&
              cards[currentCardIndex].title !== 'Configuration Password Required'
            "
          >
            <button mat-raised-button color="primary" (click)="nextCard()">
              Next
              <mat-icon svgIcon="right-arrow"></mat-icon>
            </button>
          </ng-container>
        </div>
      </div>
    </div>
  </ng-container>
</div>
