<div class="modal-container">
  <!-- Modal Header -->
  <header class="modal-header" data-tauri-drag-region>
    <div class="header-content">
      <button type="button" aria-label="Help">
        <mat-icon svgIcon="question"></mat-icon>
      </button>
      <p>
        <mat-icon svgIcon="hard-drive" aria-hidden="true"></mat-icon>
        {{ editTarget ? 'Edit ' + (editTarget | titlecase) + ' Settings' : 'Add New Remote' }}
      </p>
      <button type="button" (click)="close()" aria-label="Close dialog">
        <mat-icon svgIcon="circle-xmark"></mat-icon>
      </button>
    </div>
    <mat-divider></mat-divider>
  </header>

  <!-- Modal Content -->
  <main class="modal-content">
    <!-- Step 1: Remote Configuration -->
    <section *ngIf="(editTarget === 'remote') || (!editTarget && currentStep === 1)" [@slideAnimation]
      class="step-container" aria-labelledby="remote-config-heading">
      <h2 id="remote-config-heading" class="visually-hidden">Remote Configuration</h2>

      <form [formGroup]="remoteForm" (ngSubmit)="nextStep()" class="remote-form">
        <!-- Remote Name Field -->
        <mat-form-field appearance="fill">
          <mat-label>Remote Name</mat-label>
          <input matInput formControlName="name" id="remoteName" aria-describedby="remoteNameError" />
          <mat-error *ngIf="remoteForm.get('name')?.hasError('required')" id="remoteNameError">
            Remote Name is required.
          </mat-error>
          <mat-error *ngIf="remoteForm.get('name')?.hasError('nameTaken')" id="remoteNameError">
            This remote name already exists! Choose another name.
          </mat-error>
        </mat-form-field>

        <!-- Remote Type Selector -->
        <mat-form-field appearance="fill">
          <mat-label>Select Remote Type</mat-label>
          <mat-select formControlName="type" id="remoteType"
            (selectionChange)="onRemoteTypeChange(); $event.source.close()" aria-describedby="remoteTypeError">
            <mat-option *ngFor="let remote of remoteTypes" [value]="remote.value">
              {{ remote.label }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="remoteForm.get('type')?.hasError('required')" id="remoteTypeError">
            Remote Type is required.
          </mat-error>
        </mat-form-field>

        <!-- Loading State -->
        <div *ngIf="isLoading.remoteConfig" class="loading-container" aria-live="polite">
          <mat-spinner diameter="30"></mat-spinner>
          <p>Loading configuration options...</p>
        </div>

        <!-- Dynamic Fields -->
        <ng-container *ngFor="let field of dynamicRemoteFields">
          <mat-label>{{ field.Help }}</mat-label>

          <!-- Number Inputs -->
          <mat-form-field appearance="fill" *ngIf="['int', 'SizeSuffix', 'bits'].includes(field.Type)">
            <mat-label>{{ field.Value || 'No default value' }}</mat-label>
            <input matInput type="number" [formControlName]="field.Name" pattern="\d*"
              (keypress)="allowOnlyNumbers($event)" (input)="sanitizeNumberInput(field.Name)" />
          </mat-form-field>

          <!-- Select Inputs -->
          <mat-form-field appearance="fill" *ngIf="field.Type === 'Encoding' || field.Examples.length > 0">
            <mat-label>{{ field.Name }}</mat-label>
            <mat-select [formControlName]="field.Name">
              <mat-option *ngFor="let example of field.Examples" [value]="example.Value">
                {{ example.Help }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <!-- Duration Input -->
          <mat-form-field appearance="fill" *ngIf="field.Type === 'Duration'">
            <mat-label>{{ field.Name }}</mat-label>
            <input matInput type="text" [formControlName]="field.Name" />
          </mat-form-field>

          <!-- Default Text Input -->
          <mat-form-field appearance="fill" *ngIf="!['int', 'SizeSuffix', 'bits', 'Encoding', 'Duration'].includes(field.Type) && 
                                field.Examples.length === 0">
            <mat-label>{{ field.Name }}</mat-label>
            <input matInput type="text" [formControlName]="field.Name" />
          </mat-form-field>

          <!-- Boolean Toggle -->
          <mat-slide-toggle *ngIf="field.Type === 'bool'" [formControlName]="field.Name">
            {{ field.Name }}
          </mat-slide-toggle>
        </ng-container>
      </form>
    </section>

    <!-- Steps 2-6: Flags and Mount Configurations -->
    <ng-container *ngFor="let step of FLAG_TYPES; let i = index">
      <section *ngIf="(editTarget === step) || (!editTarget && currentStep === i + 2)" [@slideAnimation]
        class="step-container" [attr.aria-labelledby]="step + '-config-heading'">
        <h2 [id]="step + '-config-heading'" class="visually-hidden">{{ step | titlecase }} Configuration</h2>

        <form [formGroup]="remoteConfigForm" class="flag-form">
          <ng-container *ngIf="(step === 'mount')">
            <mat-form-field appearance="fill">
              <mat-label>Mount Path</mat-label>
              <button mat-button matSuffix type="button" (click)="selectFolder()" aria-label="Select folder">
                <mat-icon svgIcon="folder"></mat-icon>
              </button>
              <input matInput formControlName="mountPath" id="mountPath" aria-describedby="mountPathError" />
              <mat-error *ngIf="remoteConfigForm.get('mountPath')?.hasError('required')" id="mountPathError">
                Mount Path is required.
              </mat-error>
            </mat-form-field>
    
            <!-- Auto Mount Toggle -->
            <mat-slide-toggle formControlName="autoMount" id="autoMount">
              Auto Mount
            </mat-slide-toggle>
    
            <!-- Mount Type Selector -->
            <mat-form-field appearance="fill">
              <mat-label>Mount Type</mat-label>
              <mat-select formControlName="mountType" id="mountType"
                (selectionChange)="onMountTypeChange(); $event.source.close()" aria-describedby="mountTypeError">
                <mat-option *ngFor="let mount of mountTypes" [value]="mount.value">
                  {{ mount.label }}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="remoteConfigForm.get('mountType')?.hasError('required')" id="mountTypeError">
                Mount Type is required.
              </mat-error>
            </mat-form-field>
          </ng-container>

          <div class="json-config-container">
            <mat-form-field appearance="fill" style="width: 100%;" formGroupName="jsonConfigs">
              <mat-label>{{ step | titlecase }} Configuration</mat-label>
              <button mat-button matSuffix type="button" (click)="resetJson(step)"
                attr.aria-label="Reset {{ step }} configuration"
                *ngIf="remoteConfigForm.get('jsonConfigs')?.get(step)?.value">
                <mat-icon svgIcon="circle-xmark"></mat-icon>
              </button>
              <textarea matInput [formControlName]="step" #jsonArea (input)="validateJson(step)"
                [attr.aria-describedby]="step + 'JsonError'" spellcheck="false"></textarea>
              <mat-error *ngIf="remoteConfigForm.get('jsonConfigs')?.get(step)?.hasError('invalidJson')"
                [id]="step + 'JsonError'">
                Invalid JSON format in {{ step }} configuration!
              </mat-error>
            </mat-form-field>

            <mat-chip-set [attr.aria-label]="step + ' configuration options'"
              [disabled]="!remoteConfigForm.get('jsonConfigs')?.get(step)?.valid">
              <mat-chip-option *ngFor="let field of dynamicFlagFields[step]" (click)="toggleOption(step, field)"
                [selected]="selectedOptions[step] && selectedOptions[step].hasOwnProperty(field.name)"
                [matTooltip]="field.help" [matTooltipShowDelay]="400" [matTooltipHideDelay]="100"
                [matTooltipPosition]="'above'">
                {{ field.name }}
              </mat-chip-option>
            </mat-chip-set>
          </div>
        </form>
      </section>
    </ng-container>
  </main>

  <!-- Footer Buttons -->
  <footer class="button-container">
    <div class="button-container-inner">
      <!-- Navigation Buttons -->
      <button *ngIf="currentStep < TOTAL_STEPS && !editTarget" class="next" (click)="nextStep()"
        [disabled]="!remoteForm.valid" [@fadeInOut]>
        Next
      </button>
      <button *ngIf="currentStep > 1 && !editTarget" class="back" (click)="prevStep()" [@fadeInOut]>
        Back
      </button>
    </div>

    <!-- Save Buttons -->
    <button class="finish" (click)="onSubmit()"
      [disabled]="isLoading.saving || !remoteConfigForm.valid || !remoteForm.valid" [@fadeInOut]
      *ngIf="currentStep > 1 && !editTarget" aria-live="polite">
      {{ isLoading.saving ? 'Saving...' : 'Save' }}
    </button>

    <button class="finish" (click)="onSubmit()"
      [disabled]="isLoading.saving || (editTarget === 'remote' && !remoteForm.valid) || (editTarget === 'mount' && !remoteConfigForm.valid)"
      [@fadeInOut] *ngIf="editTarget" aria-live="polite">
      {{ isLoading.saving ? 'Saving...' : 'Save' }}
    </button>
  </footer>
</div>